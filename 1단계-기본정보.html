<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>마늘 생산비 조사 - 1단계: 기본정보</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .fade-in { animation: fadeIn 0.3s ease-in; }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        @media (max-width: 640px) {
            .survey-container { padding: 1rem; }
            .question-card { padding: 1.5rem; }
        }
    </style>
</head>
<body class="bg-gradient-to-br from-blue-50 to-indigo-50 min-h-screen">
    <div id="app"></div>

    <script>
        const surveyState = {
            currentStep: 0,
            formData: {},
            phoneNumber: '',
            stage: 1
        };

        const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbxyddb2aW1WXORKjC0oJsabEPKX1_KgGT_xpg4Op2O2Zm1QiHUWl9XZyjjAuWevwm2w/exec';

        function formatPhone(value) {
            const numbers = value.replace(/[^0-9]/g, '');
            if (numbers.length <= 3) return numbers;
            if (numbers.length <= 7) return numbers.slice(0, 3) + '-' + numbers.slice(3);
            if (numbers.length <= 11) return numbers.slice(0, 3) + '-' + numbers.slice(3, 7) + '-' + numbers.slice(7);
            return numbers.slice(0, 3) + '-' + numbers.slice(3, 7) + '-' + numbers.slice(7, 11);
        }

        function saveData() {
            if (surveyState.phoneNumber) {
                const dataToSave = {
                    ...surveyState.formData,
                    savedAt: new Date().toISOString(),
                    stage: surveyState.stage,
                    phoneNumber: surveyState.phoneNumber
                };
                localStorage.setItem(`garlic_survey_${surveyState.phoneNumber}`, JSON.stringify(dataToSave));
            }
        }

        function loadData() {
            if (surveyState.phoneNumber) {
                const savedData = localStorage.getItem(`garlic_survey_${surveyState.phoneNumber}`);
                if (savedData) {
                    const parsed = JSON.parse(savedData);
                    surveyState.formData = parsed;
                    return true;
                }
            }
            return false;
        }

        const allQuestions = [
            {
                id: 0,
                type: 'section_intro',
                title: '마늘 생산비 조사',
                subtitle: '1단계: 기본정보',
                question: '농가 기본정보 조사',
                description: '농가 위치, 경력, 재배면적 등을 조사합니다. 약 5분 소요됩니다.'
            },
            {
                id: 1,
                section: '개인정보 동의',
                type: 'radio',
                question: '개인정보 수집 및 이용에 동의하십니까?',
                helper: '성명, 주소, 연락처, 재배면적 등의 정보가 조사 목적으로만 사용되며, 2년 후 파기됩니다.',
                options: ['동의합니다', '동의하지 않습니다'],
                key: 'consent',
                required: true
            },
            {
                id: 2,
                section: '기본정보',
                type: 'text',
                question: '이름을 알려주세요',
                helper: '예: 홍길동',
                key: 'name',
                required: true
            },
            {
                id: 3,
                section: '기본정보',
                type: 'text',
                question: '농가가 위치한 지역 시/군을 알려주세요.',
                helper: '예: 보은군',
                key: 'farmer_city',
                required: true
            },
            {
                id: 4,
                section: '기본정보',
                type: 'text',
                question: '농가가 위치한 읍/면을 알려주세요.',
                helper: '예: 탄부면',
                key: 'farmer_district',
                required: true
            },
            {
                id: 5,
                section: '기본정보',
                type: 'number',
                question: '마늘 농사 경력은 몇 년입니까?',
                helper: '올해를 포함하여 총 몇 년인지 입력해주세요',
                unit: '년',
                key: 'farming_experience',
                required: true
            },
            {
                id: 6,
                section: '기본정보',
                type: 'checkbox',
                question: '재배하는 마늘 품종을 모두 선택해주세요',
                options: ['남도종', '대서종', '한지형', '기타'],
                key: 'garlic_varieties',
                required: true
            },
            {
                id: 7,
                section: '기본정보',
                type: 'area_by_variety',
                question: '품종별로 마늘 재배 면적은 몇 평입니까?',
                helper: '선택하신 품종별로 입력해주세요',
                unit: '평',
                key: 'area_by_variety',
                required: true,
                conditional: (data) => Array.isArray(data.garlic_varieties) && data.garlic_varieties.length > 0
            },
            {
                id: 8,
                section: '기본정보',
                type: 'checkbox',
                question: '재배방식을 모두 선택해주세요.',
                helper: '해당되는 항목을 모두 선택해주세요',
                options: ['노지재배', '시설재배(하우스)', '친환경재배'],
                key: 'field_method',
                required: true
            },
            {
                id: 9,
                section: '기본정보',
                type: 'radio',
                question: '이모작을 하십니까?',
                options: ['네, 합니다', '아니오, 안합니다'],
                key: 'double_crop'
            },
            {
                id: 10,
                section: '기본정보',
                type: 'radio',
                question: '재배 토지는 자가 소유입니까?',
                options: ['자가 소유', '임차', '자가 + 임차 혼합'],
                key: 'land_ownership'
            },
            {
                id: 11,
                section: '기본정보',
                type: 'money',
                question: '올해 토지 임차료는 총 얼마입니까?',
                helper: '임차한 토지 전체의 연간 임차료 총액을 입력해주세요 (평당 평균 5,000~15,000원)',
                key: 'land_rental_cost',
                conditional: (data) => data.land_ownership !== '자가 소유'
            },
            {
                id: 12,
                section: '기본정보',
                type: 'checkbox',
                question: '보유하고 있는 농기계를 모두 선택해주세요',
                options: ['트랙터', '경운기', '파종기', '수확기', '건조기', '저온저장고', '없음'],
                key: 'owned_equipment'
            },
            {
                id: 13,
                section: '기본정보',
                type: 'checkbox',
                question: '주로 어떤 방식으로 판매하십니까?',
                helper: '판매방식을 모두 선택해주세요',
                options: ['산지 유통인/수집상 대상 판매', '농협 공판장/도매시장 경매', '계약 재배 및 출하', '가공업체 대상 판매', '직접 판매(장터/온라인/택배 등)'],
                key: 'sales_method'
            },
            {
                id: 14,
                section: '기본정보',
                type: 'radio',
                question: '연령대를 선택해주세요',
                options: ['40대 이하', '50대', '60대', '70대', '80대 이상'],
                key: 'age_group'
            }
        ];

        function getVisibleQuestions() {
            return allQuestions.filter(q => {
                if (!q.conditional) return true;
                return q.conditional(surveyState.formData);
            });
        }

        function isStepComplete(step) {
            const question = getVisibleQuestions()[step];
            if (!question || !question.required) return true;
            
            const value = surveyState.formData[question.key];
            if (question.type === 'checkbox') {
                return Array.isArray(value) && value.length > 0;
            }
            if (question.type === 'area_by_variety') {
                const varieties = surveyState.formData.garlic_varieties || [];
                if (varieties.length === 0) return false;
                
                // 모든 선택된 품종의 면적이 입력되었는지 확인
                const allAreasEntered = varieties.every(v => value && value[v] && value[v] > 0);
                
                // "기타"를 선택했다면 품종명도 입력되었는지 확인
                if (varieties.includes('기타')) {
                    const customVarietyName = value && value['기타_품종명'];
                    return allAreasEntered && customVarietyName && customVarietyName.trim() !== '';
                }
                
                return allAreasEntered;
            }
            return value !== undefined && value !== null && value !== '';
        }

        function canMoveForward() {
            return isStepComplete(surveyState.currentStep);
        }

        function nextStep() {
            if (!canMoveForward()) {
                alert('필수 항목을 입력해주세요');
                return;
            }
            
            saveData();
            
            const visibleQuestions = getVisibleQuestions();
            if (surveyState.currentStep < visibleQuestions.length - 1) {
                surveyState.currentStep++;
                render();
            }
        }

        function prevStep() {
            if (surveyState.currentStep > 0) {
                surveyState.currentStep--;
                render();
            }
        }

        async function submitSurvey() {
            if (!canMoveForward()) {
                alert('필수 항목을 입력해주세요');
                return;
            }

            const confirmed = confirm('1단계를 제출하시겠습니까?\n나중에 수정할 수 있습니다.');
            if (!confirmed) return;

            try {
                const submitData = {
                    phoneNumber: surveyState.phoneNumber,
                    stage: 1,
                    formData: surveyState.formData,
                    completed_stage_1: true,
                    timestamp: new Date().toISOString()
                };

                await fetch(SCRIPT_URL, {
                    method: 'POST',
                    mode: 'no-cors',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(submitData)
                });

                saveData();
                localStorage.setItem(`garlic_survey_${surveyState.phoneNumber}`, JSON.stringify(submitData));

                alert('✅ 1단계가 제출되었습니다!');
                window.location.href = 'index.html';
            } catch (error) {
                console.error('제출 오류:', error);
                alert('제출 중 오류가 발생했습니다. 다시 시도해주세요.');
            }
        }

        function renderQuestion(question) {
            const value = surveyState.formData[question.key];

            switch (question.type) {
                case 'section_intro':
                    return `
                        <div class="text-center py-12">
                            <h1 class="text-4xl font-bold text-gray-800 mb-4">${question.title}</h1>
                            <h2 class="text-2xl font-semibold text-blue-600 mb-6">${question.subtitle}</h2>
                            <p class="text-xl text-gray-700 mb-4">${question.question}</p>
                            <p class="text-gray-600">${question.description}</p>
                        </div>
                    `;

                case 'text':
                    return `
                        <div class="space-y-4">
                            <label class="block">
                                <span class="text-lg font-medium text-gray-700">${question.question}</span>
                                ${question.required ? '<span class="text-red-500 ml-1">*</span>' : ''}
                                ${question.helper ? `<p class="text-sm text-gray-500 mt-1">${question.helper}</p>` : ''}
                                <input type="text" 
                                       class="mt-2 block w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                                       value="${value || ''}"
                                       placeholder="${question.helper ? question.helper.replace('예: ', '') : '입력하세요'}"
                                       onchange="surveyState.formData['${question.key}'] = this.value; render();">
                            </label>
                        </div>
                    `;

                case 'number':
                    return `
                        <div class="space-y-4">
                            <label class="block">
                                <span class="text-lg font-medium text-gray-700">${question.question}</span>
                                ${question.required ? '<span class="text-red-500 ml-1">*</span>' : ''}
                                ${question.helper ? `<p class="text-sm text-gray-500 mt-1">${question.helper}</p>` : ''}
                                <div class="mt-2 flex items-center">
                                    <input type="number" 
                                           class="block w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                                           value="${value || ''}"
                                           placeholder="숫자를 입력하세요"
                                           onchange="surveyState.formData['${question.key}'] = this.value; render();">
                                    ${question.unit ? `<span class="ml-3 text-gray-600">${question.unit}</span>` : ''}
                                </div>
                            </label>
                        </div>
                    `;

                case 'money':
                    return `
                        <div class="space-y-4">
                            <label class="block">
                                <span class="text-lg font-medium text-gray-700">${question.question}</span>
                                ${question.required ? '<span class="text-red-500 ml-1">*</span>' : ''}
                                ${question.helper ? `<p class="text-sm text-gray-500 mt-1">${question.helper}</p>` : ''}
                                <div class="mt-2 flex items-center">
                                    <input type="number" 
                                           class="block w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                                           value="${value || ''}"
                                           placeholder="금액을 입력하세요"
                                           onchange="surveyState.formData['${question.key}'] = this.value; render();">
                                    <span class="ml-3 text-gray-600">원</span>
                                </div>
                            </label>
                        </div>
                    `;

                case 'radio':
                    return `
                        <div class="space-y-4">
                            <div>
                                <span class="text-lg font-medium text-gray-700">${question.question}</span>
                                ${question.required ? '<span class="text-red-500 ml-1">*</span>' : ''}
                                ${question.helper ? `<p class="text-sm text-gray-500 mt-1">${question.helper}</p>` : ''}
                            </div>
                            <div class="space-y-3">
                                ${question.options.map(option => `
                                    <label class="flex items-center p-4 border-2 rounded-lg cursor-pointer hover:bg-blue-50 ${value === option ? 'border-blue-500 bg-blue-50' : 'border-gray-300'}">
                                        <input type="radio" 
                                               name="${question.key}" 
                                               value="${option}"
                                               class="w-5 h-5 text-blue-600"
                                               ${value === option ? 'checked' : ''}
                                               onchange="surveyState.formData['${question.key}'] = this.value; render();">
                                        <span class="ml-3 text-gray-700">${option}</span>
                                    </label>
                                `).join('')}
                            </div>
                        </div>
                    `;

                case 'checkbox':
                    const selectedValues = Array.isArray(value) ? value : [];
                    return `
                        <div class="space-y-4">
                            <div>
                                <span class="text-lg font-medium text-gray-700">${question.question}</span>
                                ${question.required ? '<span class="text-red-500 ml-1">*</span>' : ''}
                                ${question.helper ? `<p class="text-sm text-gray-500 mt-1">${question.helper}</p>` : ''}
                            </div>
                            <div class="space-y-3">
                                ${question.options.map(option => {
                                    const isChecked = selectedValues.includes(option);
                                    return `
                                        <label class="flex items-center p-4 border-2 rounded-lg cursor-pointer hover:bg-blue-50 ${isChecked ? 'border-blue-500 bg-blue-50' : 'border-gray-300'}">
                                            <input type="checkbox" 
                                                   value="${option}"
                                                   class="w-5 h-5 text-blue-600 rounded"
                                                   ${isChecked ? 'checked' : ''}
                                                   onchange="
                                                       const currentValues = surveyState.formData['${question.key}'] || [];
                                                       if (this.checked) {
                                                           surveyState.formData['${question.key}'] = [...currentValues, '${option}'];
                                                       } else {
                                                           surveyState.formData['${question.key}'] = currentValues.filter(v => v !== '${option}');
                                                       }
                                                       render();
                                                   ">
                                            <span class="ml-3 text-gray-700">${option}</span>
                                        </label>
                                    `;
                                }).join('')}
                            </div>
                        </div>
                    `;

                case 'area_by_variety':
                    const varieties = surveyState.formData.garlic_varieties || [];
                    
                    // 품종이 하나도 선택되지 않았으면 아무것도 표시하지 않음
                    if (!varieties || varieties.length === 0) {
                        return '';
                    }
                    
                    const areaData = value || {};
                    
                    return `
                        <div class="space-y-4">
                            <div>
                                <span class="text-lg font-medium text-gray-700">${question.question}</span>
                                ${question.required ? '<span class="text-red-500 ml-1">*</span>' : ''}
                                ${question.helper ? `<p class="text-sm text-gray-500 mt-1">${question.helper}</p>` : ''}
                            </div>
                            <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4">
                                ${varieties.map(variety => {
                                    if (variety === '기타') {
                                        // 기타 품종: 품종명 + 면적 입력
                                        const customVarietyName = (areaData['기타_품종명'] || '');
                                        return `
                                            <div class="bg-gray-50 p-4 rounded-lg col-span-full">
                                                <label class="block mb-3">
                                                    <span class="text-gray-700 font-medium mb-2 block">기타 품종명</span>
                                                    <input type="text" 
                                                           class="w-full px-3 py-2 border-2 border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                                                           value="${customVarietyName}"
                                                           placeholder="품종명을 입력하세요 (예: 의성, 서산)"
                                                           onchange="
                                                               if (!surveyState.formData['${question.key}']) {
                                                                   surveyState.formData['${question.key}'] = {};
                                                               }
                                                               surveyState.formData['${question.key}']['기타_품종명'] = this.value;
                                                               render();
                                                           ">
                                                </label>
                                                <label class="block">
                                                    <span class="text-gray-700 font-medium mb-2 block">기타 품종 재배면적</span>
                                                    <div class="flex items-center gap-2">
                                                        <input type="number" 
                                                               class="flex-1 px-3 py-2 border-2 border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                                                               value="${areaData['기타'] || ''}"
                                                               placeholder="면적 입력"
                                                               step="0.01"
                                                               min="0"
                                                               onchange="
                                                                   if (!surveyState.formData['${question.key}']) {
                                                                       surveyState.formData['${question.key}'] = {};
                                                                   }
                                                                   surveyState.formData['${question.key}']['기타'] = this.value;
                                                                   render();
                                                               ">
                                                        <span class="text-gray-600 font-medium whitespace-nowrap">${question.unit}</span>
                                                    </div>
                                                </label>
                                            </div>
                                        `;
                                    } else {
                                        // 일반 품종: 면적만 입력
                                        return `
                                            <div class="bg-gray-50 p-4 rounded-lg">
                                                <label class="block">
                                                    <span class="text-gray-700 font-medium mb-2 block">${variety}</span>
                                                    <div class="flex items-center gap-2">
                                                        <input type="number" 
                                                               class="w-full px-3 py-2 border-2 border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                                                               value="${areaData[variety] || ''}"
                                                               placeholder="면적 입력"
                                                               step="0.01"
                                                               min="0"
                                                               onchange="
                                                                   if (!surveyState.formData['${question.key}']) {
                                                                       surveyState.formData['${question.key}'] = {};
                                                                   }
                                                                   surveyState.formData['${question.key}']['${variety}'] = this.value;
                                                                   render();
                                                               ">
                                                        <span class="text-gray-600 font-medium whitespace-nowrap">${question.unit}</span>
                                                    </div>
                                                </label>
                                            </div>
                                        `;
                                    }
                                }).join('')}
                            </div>
                        </div>
                    `;

                default:
                    return '<p class="text-gray-500">알 수 없는 질문 유형입니다.</p>';
            }
        }

        function render() {
            const app = document.getElementById('app');
            const visibleQuestions = getVisibleQuestions();
            const currentQuestion = visibleQuestions[surveyState.currentStep];
            const isLastStep = surveyState.currentStep === visibleQuestions.length - 1;
            const isFirstStep = surveyState.currentStep === 0;

            app.innerHTML = `
                <div class="survey-container max-w-3xl mx-auto p-6">
                    <!-- Header -->
                    <div class="bg-white rounded-lg shadow-lg p-6 mb-6">
                        <div class="flex justify-between items-center">
                            <div>
                                <h1 class="text-2xl font-bold text-gray-800">마늘 생산비 조사</h1>
                                <p class="text-sm text-blue-600">1단계: 기본정보</p>
                            </div>
                            <a href="index.html" class="px-4 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300">
                                메인으로
                            </a>
                        </div>
                        <div class="mt-4">
                            <div class="flex justify-between text-sm text-gray-600 mb-2">
                                <span>진행률</span>
                                <span>${surveyState.currentStep + 1} / ${visibleQuestions.length}</span>
                            </div>
                            <div class="w-full bg-gray-200 rounded-full h-2">
                                <div class="bg-blue-600 h-2 rounded-full transition-all duration-300" 
                                     style="width: ${((surveyState.currentStep + 1) / visibleQuestions.length) * 100}%">
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Question Card -->
                    <div class="question-card bg-white rounded-lg shadow-lg p-8 mb-6 fade-in">
                        ${currentQuestion.section && currentQuestion.type !== 'section_intro' ? 
                            `<div class="text-sm font-semibold text-blue-600 mb-4">${currentQuestion.section}</div>` : ''}
                        ${renderQuestion(currentQuestion)}
                    </div>

                    <!-- Navigation -->
                    <div class="flex gap-4">
                        <button onclick="prevStep()" 
                                class="flex-1 px-6 py-3 border-2 border-gray-300 text-gray-700 rounded-lg font-medium hover:bg-gray-50 disabled:opacity-50 disabled:cursor-not-allowed"
                                ${isFirstStep ? 'disabled' : ''}>
                            ← 이전
                        </button>
                        ${!isLastStep ? `
                            <button onclick="nextStep()" 
                                    class="flex-1 px-6 py-3 bg-blue-600 text-white rounded-lg font-medium hover:bg-blue-700 disabled:opacity-50 disabled:cursor-not-allowed"
                                    ${!canMoveForward() ? 'disabled' : ''}>
                                다음 →
                            </button>
                        ` : `
                            <button onclick="submitSurvey()" 
                                    class="flex-1 px-6 py-3 bg-green-600 text-white rounded-lg font-medium hover:bg-green-700 disabled:opacity-50 disabled:cursor-not-allowed"
                                    ${!canMoveForward() ? 'disabled' : ''}>
                                ✓ 제출하기
                            </button>
                        `}
                    </div>
                </div>
            `;
        }

        // 초기화
        surveyState.phoneNumber = localStorage.getItem('garlic_survey_phone');
        if (!surveyState.phoneNumber) {
            alert('로그인이 필요합니다');
            window.location.href = 'index.html';
        } else {
            loadData();
            render();
        }
    </script>
</body>
</html>
